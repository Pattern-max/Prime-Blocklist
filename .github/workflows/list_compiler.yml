# .github/workflows/list_compiler.yml
name: Compile Prime Blocklist

on:
  schedule:
    - cron: '20 * * * *'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Merge and Compile Lists
        run: |
          set -e  # è®¾ç½®é”™è¯¯æ—¶ç«‹å³é€€å‡ºï¼Œä¾¿äºè°ƒè¯•
          mkdir -p list
          
          # ç‰ˆæœ¬ç®¡ç†åˆå§‹åŒ–
          [ ! -f version.txt ] && echo "1.00" > version.txt
          current_version=$(cat version.txt)

          echo "ğŸš€ å¼€å§‹ç¼–è¯‘ Prime Blocklist"
          echo "=========================================="

          # 1. ä¸‹è½½æ ¸å¿ƒæ‹¦æˆªåˆ—è¡¨
          echo "â¬‡ï¸  1. ä¸‹è½½ä¸»æ‹¦æˆªè§„åˆ™ (pro.plus.txt)..."
          if ! curl -s --retry 3 "https://raw.githubusercontent.com/hagezi/dns-blocklists/main/adblock/pro.plus.txt" -o list_pro.txt || [ ! -s list_pro.txt ]; then
            echo "âŒ é”™è¯¯: pro.plus.txt ä¸‹è½½å¤±è´¥æˆ–ä¸ºç©º"
            exit 1
          fi

          echo "â¬‡ï¸  2. ä¸‹è½½è¡¥å……æ‹¦æˆªè§„åˆ™ (tif.txt)..."
          if ! curl -s --retry 3 "https://raw.githubusercontent.com/hagezi/dns-blocklists/main/adblock/tif.txt" -o list_tif.txt || [ ! -s list_tif.txt ]; then
            echo "âŒ é”™è¯¯: tif.txt ä¸‹è½½å¤±è´¥æˆ–ä¸ºç©º"
            exit 1
          fi

          # 2. åˆå¹¶å¹¶é¢„å¤„ç†æ‹¦æˆªè§„åˆ™
          echo "ğŸ§¹ 3. é¢„å¤„ç†è§„åˆ™ï¼ˆç§»é™¤æ³¨é‡Šã€ç©ºè¡Œï¼‰..."
          grep -vh -e '^!' -e '^#' -e '^\[' -e '^$' list_pro.txt list_tif.txt > combined_block.txt
          initial_count=$(sort -u combined_block.txt | wc -l | xargs)
          echo "   â†’ åˆå¹¶åå”¯ä¸€æ‹¦æˆªè§„åˆ™æ•°: $initial_count"

          # 3. ä¸‹è½½å¹¶åº”ç”¨hageziæ¨èç™½åå•
          echo "ğŸ›¡ï¸  4. åº”ç”¨hageziæ¨èç™½åå• (whitelist-referral.txt)..."
          curl -s --retry 3 "https://raw.githubusercontent.com/hagezi/dns-blocklists/main/adblock/whitelist-referral.txt" -o whitelist_hagezi.txt
          
          # é¢„å¤„ç†ç™½åå•è§„åˆ™ï¼šç§»é™¤æ³¨é‡Šã€ç©ºè¡Œå’Œ"@@"å–æ¶ˆé˜»æ­¢æ ‡è®°
          grep -v -e '^!' -e '^#' -e '^\[' -e '^$' whitelist_hagezi.txt | sed 's/^@@//' > whitelist_clean.txt
          
          if [ -s "whitelist_clean.txt" ]; then
            # ä¿®æ­£ï¼šä½¿ç”¨æ­£ç¡®çš„grepé€‰é¡¹
            grep -vFf whitelist_clean.txt combined_block.txt > combined_after_hagezi_whitelist.txt
            mv combined_after_hagezi_whitelist.txt combined_block.txt
            hagezi_whitelist_count=$(wc -l < whitelist_clean.txt | xargs)
            echo "   â†’ å·²åº”ç”¨hageziç™½åå•æ¡ç›®: $hagezi_whitelist_count"
          else
            echo "   â†’ hageziç™½åå•ä¸ºç©ºæˆ–å¤„ç†å¤±è´¥ï¼Œè·³è¿‡æ­¤æ­¥éª¤"
          fi

          # 4. åº”ç”¨æœ¬åœ°åº”æ€¥ç™½åå• (allowlist.txt) - ä¿®å¤ç‰ˆ
          local_removed_count=0
          if [ -f "allowlist.txt" ] && [ -s "allowlist.txt" ]; then
            echo "ğŸ“ 5. åº”ç”¨æœ¬åœ°åº”æ€¥ç™½åå• (allowlist.txt)..."
            # å®‰å…¨åœ°æ¸…ç†ç™½åå•æ–‡ä»¶
            sed 's/#.*//' allowlist.txt 2>/dev/null | \
              sed 's/^[[:space:]]*//;s/[[:space:]]*$//' 2>/dev/null | \
              grep -v '^$' 2>/dev/null > local_whitelist_clean.txt || true
            
            if [ -s "local_whitelist_clean.txt" ]; then
              # åº”ç”¨ç™½åå•å¹¶ç»Ÿè®¡ç§»é™¤æ•°é‡
              temp_count_before=$(wc -l < combined_block.txt)
              grep -vFf local_whitelist_clean.txt combined_block.txt > combined_temp.txt
              temp_count_after=$(wc -l < combined_temp.txt)
              local_removed_count=$((temp_count_before - temp_count_after))
              
              # æ›´æ–°combined_block.txt
              mv combined_temp.txt combined_block.txt
              
              echo "   â†’ å·²ç§»é™¤æœ¬åœ°ç™½åå•æ¡ç›®: $local_removed_count"
            else
              echo "   â†’ æœ¬åœ°ç™½åå•æ— æœ‰æ•ˆæ¡ç›®ï¼Œè·³è¿‡å¤„ç†"
            fi
            # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            rm -f local_whitelist_clean.txt
          else
            echo "ğŸ“ 5. æœªæ‰¾åˆ°éç©ºæœ¬åœ°ç™½åå•ï¼Œè·³è¿‡æ­¤æ­¥éª¤"
          fi

          # 5. æœ€ç»ˆå»é‡ä¸ç»Ÿè®¡
          echo "ğŸ” 6. æœ€ç»ˆå»é‡ä¸ç»Ÿè®¡..."
          sort -u combined_block.txt > final_rules.txt
          final_count=$(wc -l < final_rules.txt | xargs)
          echo "   â†’ æœ€ç»ˆå”¯ä¸€è§„åˆ™æ€»æ•°: $final_count"

          # 6. ç‰ˆæœ¬ç®¡ç†
          previous_count=$(grep -oP '! Total count: \K\d+' list/Prime_Blocklist.txt 2>/dev/null || echo "0")
          if [[ "$final_count" != "$previous_count" ]] || [[ ! -f "list/Prime_Blocklist.txt" ]]; then
            new_version=$(awk "BEGIN {printf \"%.2f\", $current_version + 0.01}")
            echo "$new_version" > version.txt
            echo "ğŸ“ˆ ç‰ˆæœ¬æ›´æ–°: v$current_version -> v$new_version (è§„åˆ™æ•°: $previous_count -> $final_count)"
            should_commit=true
          else
            echo "ğŸ“Š è§„åˆ™æ•°é‡æœªå˜åŒ– ($final_count)ï¼Œä¿æŒç‰ˆæœ¬: v$current_version"
            should_commit=false
          fi

          # 7. ç”Ÿæˆæœ€ç»ˆæ–‡ä»¶ï¼ˆæç®€å¤´éƒ¨ï¼‰
          {
            echo "[Adblock Plus 2.0]"
            echo "! Title: Prime Blocklist"
            echo "! Version: $(cat version.txt)"
            echo "! Updated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
            echo "! Total count: $final_count"
            echo ""
            cat final_rules.txt
          } > list/Prime_Blocklist.txt

          # 8. æ¸…ç†ä¸æœ€ç»ˆæŠ¥å‘Š
          rm -f list_*.txt combined_block.txt whitelist_*.txt final_rules.txt
          echo ""
          echo "âœ… Prime Blocklist ç¼–è¯‘å®Œæˆï¼"
          echo "ğŸ“ è¾“å‡ºæ–‡ä»¶: list/Prime_Blocklist.txt"
          echo "ğŸ“ æœ€ç»ˆè§„åˆ™æ•°: $final_count"
          [ "$should_commit" = true ] && echo "ğŸ”„ æ£€æµ‹åˆ°å˜æ›´ï¼Œå°†æäº¤æ–°ç‰ˆæœ¬" || echo "ğŸ’¤ æ— å˜æ›´ï¼Œå°†æ¨é€ç©ºæäº¤"

      - name: Commit and Push
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'
          git add list/Prime_Blocklist.txt version.txt
          
          if [[ -n $(git status --porcelain list/Prime_Blocklist.txt) ]]; then
            git commit -m "Update Prime Blocklist to v$(cat version.txt) [$(date +%Y-%m-%d)]"
            git push
            echo "âœ… å·²æäº¤å¹¶æ¨é€æ–°ç‰ˆæœ¬è§„åˆ™"
          else
            git commit --allow-empty -m "Scheduled run, no changes [$(date +%Y-%m-%d)]"
            git push
            echo "â­ï¸  è§„åˆ™æ— å˜åŒ–ï¼Œå·²æ¨é€ç©ºæäº¤ä¿æŒæ´»è·ƒ"
          fi
