name: Compile Optimized NetBlocker

on:
  schedule:
    - cron: '20 * * * *'  # æ¯å°æ—¶ç¬¬20åˆ†é’Ÿè¿è¡Œï¼Œä¿æŒæ›´æ–°é¢‘ç‡
  workflow_dispatch:       # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Setup and Compile
        run: |
          mkdir -p list
          
          # åˆå§‹åŒ–ç‰ˆæœ¬å·æ–‡ä»¶
          if [ ! -f version.txt ]; then echo "1.00" > version.txt; fi
          current_version=$(cat version.txt)
          
          echo "ğŸš€ å¼€å§‹ç¼–è¯‘ NetBlocker..."
          echo "å½“å‰ç‰ˆæœ¬: $current_version"
          echo "è§„åˆ™æº: $(cat sources.txt)"

          # ä¸‹è½½å¹¶é¢„å¤„ç†ä¸»è§„åˆ™åˆ—è¡¨
          echo "â¬‡ï¸  ä¸‹è½½ AdGuard DNS ä¸»è§„åˆ™åˆ—è¡¨..."
          curl -s "https://adguardteam.github.io/AdGuardSDNSFilter/Filters/filter.txt" | \
            grep -v -e "^!" -e "^#" -e "^\[" > combined_raw.txt
          
          initial_count=$(wc -l < combined_raw.txt | xargs)
          echo "ä¸»è§„åˆ™åˆ—è¡¨åŸå§‹æ¡æ•°: $initial_count"

          # å¤„ç†æœ¬åœ°åº”æ€¥ç™½åå• (å¦‚æœå­˜åœ¨)
          removed_count=0
          if [ -f "allowlist.txt" ] && [ -s "allowlist.txt" ]; then
            echo "ğŸ›¡ï¸  åº”ç”¨æœ¬åœ°åº”æ€¥ç™½åå• (allowlist.txt)..."
            # æ¸…ç†ç™½åå•æ–‡ä»¶ï¼šç§»é™¤æ³¨é‡Šã€ç©ºæ ¼å’Œç©ºè¡Œ
            sed 's/#.*//' allowlist.txt | \
                sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | \
                sed '/^$/d' > local_whitelist_clean.txt
            
            if [ -s "local_whitelist_clean.txt" ]; then
              local_whitelist_count=$(wc -l < local_whitelist_clean.txt | xargs)
              echo "æœ¬åœ°ç™½åå•æœ‰æ•ˆæ¡ç›®: $local_whitelist_count"
              
              # åº”ç”¨ç™½åå•ï¼Œç§»é™¤è¢«å…è®¸çš„åŸŸå
              grep -vFx -f local_whitelist_clean.txt combined_raw.txt > combined_cleaned.txt
              
              final_count=$(wc -l < combined_cleaned.txt | xargs)
              removed_count=$((initial_count - final_count))
              echo "é€šè¿‡æœ¬åœ°ç™½åå•ç§»é™¤æ¡ç›®: $removed_count"
            else
              mv combined_raw.txt combined_cleaned.txt
              echo "â„¹ï¸  æœ¬åœ°ç™½åå•æ— æœ‰æ•ˆæ¡ç›®ï¼Œè·³è¿‡å¤„ç†ã€‚"
            fi
            rm -f local_whitelist_clean.txt
          else
            mv combined_raw.txt combined_cleaned.txt
            echo "â„¹ï¸  æœªæ‰¾åˆ°æœ¬åœ°ç™½åå•æ–‡ä»¶ï¼Œè·³è¿‡å¤„ç†ã€‚"
          fi

          # ä»…åœ¨è§„åˆ™æ•°é‡å˜åŒ–æ—¶æ›´æ–°ç‰ˆæœ¬
          final_count=$(wc -l < combined_cleaned.txt | xargs)
          previous_count=$(grep -oP '! Total count: \K\d+' list/NetBlocker.txt 2>/dev/null || echo "0")
          
          if [[ "$final_count" != "$previous_count" ]] || [[ ! -f "list/NetBlocker.txt" ]]; then
            new_version=$(awk "BEGIN {printf \"%.2f\", $current_version + 0.01}")
            echo $new_version > version.txt
            echo "ğŸ“ˆ è§„åˆ™æ•°å˜åŒ– ($previous_count -> $final_count)ï¼Œç‰ˆæœ¬æ›´æ–°ä¸º: $new_version"
            should_commit=true
          else
            echo "ğŸ“Š è§„åˆ™æ•°æœªå˜åŒ– ($final_count)ï¼Œä¿æŒç‰ˆæœ¬: $current_version"
            should_commit=false
          fi

          # ç”Ÿæˆæœ€ç»ˆæ–‡ä»¶å¤´
          echo "[Adblock Plus 2.0]" > header.txt
          echo "! Title: NetBlocker (Optimized)" >> header.txt
          echo "! Homepage: https://github.com/${{ github.repository }}" >> header.txt
          echo "! Version: $(cat version.txt)" >> header.txt
          echo "! Last modified: $(date -u +"%Y-%m-%d %H:%M:%S") UTC" >> header.txt
          echo "! Description: Optimized from AdGuard DNS filter. Whitelist issues should be reported upstream." >> header.txt
          echo "! Total count: $final_count" >> header.txt
          if [ $removed_count -gt 0 ]; then
            echo "! Local whitelist entries applied: $removed_count" >> header.txt
          fi
          echo "" >> header.txt
          
          # åˆå¹¶å¤´å’Œè§„åˆ™
          cat header.txt combined_cleaned.txt > list/NetBlocker.txt
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -f combined_raw.txt combined_cleaned.txt header.txt
          
          echo "âœ… ç¼–è¯‘å®Œæˆï¼æœ€ç»ˆè§„åˆ™æ•°: $final_count"
          if [ "$should_commit" = false ]; then
            echo "ğŸ’¤ æ— å®è´¨å˜æ›´ï¼Œå°†è·³è¿‡æäº¤ï¼ˆä»…è¿è¡Œç©ºæäº¤ä»¥ä¿æŒæ´»è·ƒï¼‰ã€‚"
          fi

      - name: Commit and Push
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'
          git add list/NetBlocker.txt version.txt
          
          # ä»…åœ¨è§„åˆ™æœ‰å˜åŒ–æ—¶ç”Ÿæˆæœ‰æ„ä¹‰çš„æäº¤ä¿¡æ¯
          if [[ -n $(git status --porcelain list/NetBlocker.txt) ]]; then
            git commit -m "Update NetBlocker to v$(cat version.txt) [$(date +%Y-%m-%d)]" || echo "æ— å˜æ›´å¯æäº¤"
            git push
            echo "ğŸ”„ å·²æäº¤å¹¶æ¨é€æ–°ç‰ˆæœ¬è§„åˆ™ã€‚"
          else
            git commit --allow-empty -m "Scheduled run, no changes [$(date +%Y-%m-%d)]"
            git push
            echo "â­ï¸  è§„åˆ™æ— å˜åŒ–ï¼Œå·²æ¨é€ç©ºæäº¤ä¿æŒä»“åº“æ´»è·ƒã€‚"
          fi
