name: Compile List

# Controls when the workflow will run
on:
  # Run every hour
  schedule:
    - cron: '20 * * * *'

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  build:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    permissions:
      contents: write

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v4

      # Download lists, sort and remove duplicates
      - name: Update Blocklist
        run: |
          mkdir -p list
          
          # Increment Version
          if [ ! -f version.txt ]; then echo "0.00" > version.txt; fi
          current_version=$(cat version.txt)
          new_version=$(awk "BEGIN {printf \"%.2f\", $current_version + 0.01}")
          echo $new_version > version.txt

          # Create Header
          echo "! Title: NetBlocker" > header.txt
          echo "! Version: $new_version" >> header.txt
          echo "! Last modified: $(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> header.txt
          echo "! License: https://github.com/${{ github.repository }}/blob/main/LICENSE" >> header.txt
          echo "! Aggregated from multiple high-quality blocklist sources" >> header.txt
          echo "! Whitelist applied from: allowlist.txt" >> header.txt
          echo "!" >> header.txt

          # Download and Clean
          # Loop through sources.txt, download, and clean each list
          touch combined_temp.txt
          while IFS= read -r url || [ -n "$url" ]; do
            if [ -n "$url" ]; then
              echo "Downloading $url"
              # Download, strip comments (!, #, [), and append to temp file
              curl -s "$url" | grep -v -e "^!" -e "^#" -e "^\[" >> combined_temp.txt
            fi
          done < sources.txt
          
          # Combine
          sort -u combined_temp.txt > combined_unsorted.txt
          
          # Apply Allowlist (白名单)
          if [ -f "allowlist.txt" ]; then
            echo "Applying allowlist..."
            # Clean allowlist (remove comments, whitespace, empty lines)
            # 移除行内和行首的注释（以#开头的内容）
            # 支持两种格式的注释：
            # 1. 整行注释: # comment
            # 2. 行内注释: domain.com # comment
            sed 's/#.*//' allowlist.txt | \
                sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | \
                sed '/^$/d' > allowlist_clean.txt
            
            # 统计白名单条目数
            allowlist_count=$(wc -l < allowlist_clean.txt | xargs)
            echo "Allowlist entries: $allowlist_count"
            
            # 应用白名单：从blocklist中排除白名单中的域名
            if [ -s "allowlist_clean.txt" ]; then
              grep -vFx -f allowlist_clean.txt combined_unsorted.txt > combined_cleaned.txt
              echo "Removed $(( $(wc -l < combined_unsorted.txt) - $(wc -l < combined_cleaned.txt) )) entries via allowlist"
            else
              mv combined_unsorted.txt combined_cleaned.txt
              echo "Allowlist is empty or contains only comments"
            fi
            rm allowlist_clean.txt
          else
            echo "No allowlist.txt found, skipping allowlist filter"
            mv combined_unsorted.txt combined_cleaned.txt
          fi

          # Add Count to Header
          line_count=$(wc -l < combined_cleaned.txt | xargs)
          echo "! Count: $line_count" >> header.txt
          
          # Final Output
          cat header.txt combined_cleaned.txt > list/NetBlocker.txt
          
          # Cleanup
          rm -f combined_temp.txt combined_unsorted.txt combined_cleaned.txt header.txt

      # Commit and push changes (ensuring a commit always happens)
      - name: Commit and Push
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'
          git add list/NetBlocker.txt version.txt
          # 尝试进行常规提交
          if [[ -n $(git status -s) ]]; then
            git commit -m "Update NetBlocker.txt to version $(cat version.txt)"
          else
            # 如果没有变化，就创建一个空的提交，仅更新日期
            git commit --allow-empty -m "Scheduled keep-alive commit to maintain repository activity [$(date +%Y-%m-%d)]"
          fi
          git push
