# .github/workflows/list_compiler.yml
name: Compile Prime Blocklist

on:
  schedule:
    - cron: '20 * * * *'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Merge and Compile Lists
        run: |
          set -e
          mkdir -p list
          
          # åˆå§‹åŒ–ç‰ˆæœ¬
          [ ! -f version.txt ] && echo "1.00" > version.txt
          current_version=$(cat version.txt)

          echo "ğŸš€ å¼€å§‹ç¼–è¯‘ Prime Blocklist"
          echo "=========================================="
          echo "ğŸ“‹ å°†è¯»å– sources.txt ä¸­çš„è§„åˆ™æºè¿›è¡Œé›†æˆ"
          echo "------------------------------------------"

          # 1. æ£€æŸ¥å¹¶è¯»å– sources.txt
          if [ ! -f "sources.txt" ] || [ ! -s "sources.txt" ]; then
            echo "âŒ é”™è¯¯: sources.txt æ–‡ä»¶ä¸å­˜åœ¨æˆ–ä¸ºç©º"
            exit 1
          fi

          # 2. éå† sources.txtï¼Œä¸‹è½½å¹¶åˆå¹¶æ‰€æœ‰è§„åˆ™æº
          echo "â¬‡ï¸  å¼€å§‹ä¸‹è½½å¹¶åˆå¹¶è§„åˆ™æº..."
          > all_raw_rules.txt  # æ¸…ç©ºæ–‡ä»¶ï¼Œç”¨äºæ”¶é›†æ‰€æœ‰è§„åˆ™
          source_count=0
          failed_sources=0
          
          while IFS= read -r line || [[ -n "$line" ]]; do
            # è·³è¿‡ç©ºè¡Œå’Œæ³¨é‡Šè¡Œï¼ˆä»¥#å¼€å¤´ï¼‰
            if [[ -z "$line" ]] || [[ "$line" =~ ^[[:space:]]*# ]]; then
              continue
            fi
            
            source_count=$((source_count + 1))
            filename="source_${source_count}.txt"
            echo "  [$source_count] ä¸‹è½½: $line"
            
            # ä¸‹è½½è§„åˆ™æºï¼Œå¸¦é‡è¯•å’Œé”™è¯¯æ£€æŸ¥
            if curl -s --retry 2 --max-time 30 "$line" -o "$filename"; then
              if [ -s "$filename" ]; then
                # é¢„å¤„ç†ï¼šç§»é™¤æ³¨é‡Šã€ç©ºè¡Œã€å¤´éƒ¨æ ‡è®°
                grep -v -e '^!' -e '^#' -e '^\[' -e '^$' "$filename" >> all_raw_rules.txt
                echo "      â†’ æˆåŠŸ"
              else
                echo "      âš ï¸  è­¦å‘Š: æ–‡ä»¶ä¸ºç©ºï¼Œè·³è¿‡"
                failed_sources=$((failed_sources + 1))
              fi
            else
              echo "      âŒ é”™è¯¯: ä¸‹è½½å¤±è´¥ï¼Œè·³è¿‡"
              failed_sources=$((failed_sources + 1))
            fi
            # æ¸…ç†å•æ¬¡ä¸‹è½½çš„ä¸´æ—¶æ–‡ä»¶
            rm -f "$filename"
            sleep 0.5  # çŸ­æš‚å»¶è¿Ÿï¼Œé¿å…è¯·æ±‚è¿‡å¿«
          done < sources.txt
          
          echo "------------------------------------------"
          echo "âœ… å·²å®Œæˆä¸‹è½½ã€‚æˆåŠŸ: $((source_count - failed_sources))/$source_count ä¸ªæº"
          if [ $failed_sources -gt 0 ]; then
            echo "âš ï¸  æ³¨æ„: æœ‰ $failed_sources ä¸ªæºä¸‹è½½å¤±è´¥æˆ–ä¸ºç©ºï¼Œå¯èƒ½å½±å“æœ€ç»ˆè§„åˆ™å®Œæ•´æ€§"
          fi
          
          # 3. åˆæ¬¡åˆå¹¶ä¸å»é‡
          echo "ğŸ§¹ åˆæ¬¡å»é‡..."
          sort -u all_raw_rules.txt > combined_block.txt
          initial_count=$(wc -l < combined_block.txt | xargs)
          echo "   â†’ åˆå¹¶åå”¯ä¸€æ‹¦æˆªè§„åˆ™æ•°: $initial_count"
          
          # 4. ä¸‹è½½å¹¶åº”ç”¨hageziæ¨èç™½åå•
          echo "ğŸ›¡ï¸  åº”ç”¨hageziæ¨èç™½åå• (whitelist-referral.txt)..."
          curl -s --retry 3 "https://raw.githubusercontent.com/hagezi/dns-blocklists/main/adblock/whitelist-referral.txt" -o whitelist_hagezi.txt
          
          grep -v -e '^!' -e '^#' -e '^\[' -e '^$' whitelist_hagezi.txt | sed 's/^@@//' > whitelist_clean.txt
          
          if [ -s "whitelist_clean.txt" ]; then
            grep -vFf whitelist_clean.txt combined_block.txt > combined_after_hagezi_whitelist.txt
            mv combined_after_hagezi_whitelist.txt combined_block.txt
            hagezi_whitelist_count=$(wc -l < whitelist_clean.txt | xargs)
            echo "   â†’ å·²åº”ç”¨hageziç™½åå•æ¡ç›®: $hagezi_whitelist_count"
          else
            echo "   â†’ hageziç™½åå•ä¸ºç©ºï¼Œè·³è¿‡"
          fi

          # 5. åº”ç”¨æœ¬åœ°åº”æ€¥ç™½åå• (allowlist.txt)
          local_removed_count=0
          if [ -f "allowlist.txt" ] && [ -s "allowlist.txt" ]; then
            echo "ğŸ“ åº”ç”¨æœ¬åœ°åº”æ€¥ç™½åå• (allowlist.txt)..."
            sed 's/#.*//' allowlist.txt 2>/dev/null | \
              sed 's/^[[:space:]]*//;s/[[:space:]]*$//' 2>/dev/null | \
              grep -v '^$' 2>/dev/null > local_whitelist_clean.txt || true
            
            if [ -s "local_whitelist_clean.txt" ]; then
              temp_count_before=$(wc -l < combined_block.txt)
              grep -vFf local_whitelist_clean.txt combined_block.txt > combined_temp.txt
              temp_count_after=$(wc -l < combined_temp.txt)
              local_removed_count=$((temp_count_before - temp_count_after))
              mv combined_temp.txt combined_block.txt
              echo "   â†’ å·²ç§»é™¤æœ¬åœ°ç™½åå•æ¡ç›®: $local_removed_count"
            else
              echo "   â†’ æœ¬åœ°ç™½åå•æ— æœ‰æ•ˆæ¡ç›®ï¼Œè·³è¿‡"
            fi
            rm -f local_whitelist_clean.txt
          else
            echo "ğŸ“ æœªæ‰¾åˆ°éç©ºæœ¬åœ°ç™½åå•ï¼Œè·³è¿‡"
          fi

          # 6. æœ€ç»ˆå»é‡ä¸ç»Ÿè®¡
          echo "ğŸ” æœ€ç»ˆå»é‡ä¸ç»Ÿè®¡..."
          sort -u combined_block.txt > final_rules.txt
          final_count=$(wc -l < final_rules.txt | xargs)
          echo "   â†’ æœ€ç»ˆå”¯ä¸€è§„åˆ™æ€»æ•°: $final_count"

          # 7. ç‰ˆæœ¬ç®¡ç†
          previous_count=$(grep -oP '! Total count: \K\d+' list/Prime_Blocklist.txt 2>/dev/null || echo "0")
          if [[ "$final_count" != "$previous_count" ]] || [[ ! -f "list/Prime_Blocklist.txt" ]]; then
            new_version=$(awk "BEGIN {printf \"%.2f\", $current_version + 0.01}")
            echo "$new_version" > version.txt
            echo "ğŸ“ˆ ç‰ˆæœ¬æ›´æ–°: v$current_version -> v$new_version (è§„åˆ™æ•°: $previous_count -> $final_count)"
            should_commit=true
          else
            echo "ğŸ“Š è§„åˆ™æ•°é‡æœªå˜åŒ–ï¼Œä¿æŒç‰ˆæœ¬: v$current_version"
            should_commit=false
          fi

          # 8. ç”Ÿæˆæœ€ç»ˆæ–‡ä»¶
          {
            echo "[Adblock Plus 2.0]"
            echo "! Title: Prime Blocklist"
            echo "! Version: $(cat version.txt)"
            echo "! Updated: $(date -u +\"%Y-%m-%d %H:%M:%S UTC\")"
            echo "! Total count: $final_count"
            echo ""
            cat final_rules.txt
          } > list/Prime_Blocklist.txt

          # 9. æ¸…ç†ä¸æŠ¥å‘Š
          rm -f all_raw_rules.txt combined_block.txt whitelist_*.txt final_rules.txt
          echo ""
          echo "âœ… Prime Blocklist ç¼–è¯‘å®Œæˆï¼"
          echo "ğŸ“ è¾“å‡ºæ–‡ä»¶: list/Prime_Blocklist.txt"
          echo "ğŸ“ æœ€ç»ˆè§„åˆ™æ•°: $final_count"
          [ "$should_commit" = true ] && echo "ğŸ”„ æ£€æµ‹åˆ°å˜æ›´ï¼Œå°†æäº¤æ–°ç‰ˆæœ¬" || echo "ğŸ’¤ æ— å˜æ›´ï¼Œå°†æ¨é€ç©ºæäº¤"

      - name: Commit and Push
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'
          git add list/Prime_Blocklist.txt version.txt
          
          if [[ -n $(git status --porcelain list/Prime_Blocklist.txt) ]]; then
            git commit -m "Update Prime Blocklist to v$(cat version.txt) [$(date +%Y-%m-%d)]"
            git push
            echo "âœ… å·²æäº¤å¹¶æ¨é€æ–°ç‰ˆæœ¬è§„åˆ™"
          else
            git commit --allow-empty -m "Scheduled run, no changes [$(date +%Y-%m-%d)]"
            git push
            echo "â­ï¸  è§„åˆ™æ— å˜åŒ–ï¼Œå·²æ¨é€ç©ºæäº¤ä¿æŒæ´»è·ƒ"
          fi
