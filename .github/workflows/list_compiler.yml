name: Compile Prime Blocklist

on:
  schedule:
    - cron: '20 * * * *'  # æ¯å°æ—¶ç¬¬20åˆ†é’Ÿè¿è¡Œ
  workflow_dispatch:       # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Setup and Compile
        run: |
          mkdir -p list
          
          # åˆå§‹åŒ–ç‰ˆæœ¬å·æ–‡ä»¶
          if [ ! -f version.txt ]; then echo "1.00" > version.txt; fi
          current_version=$(cat version.txt)
          
          echo "ğŸš€ å¼€å§‹ç¼–è¯‘ Prime Blocklist..."
          echo "å½“å‰ç‰ˆæœ¬: $current_version"
          
          # è¯»å–è§„åˆ™æº
          echo "ğŸ“‹ ä½¿ç”¨çš„è§„åˆ™æº:"
          cat sources.txt
          echo ""
          
          # ä¸‹è½½å¹¶åˆå¹¶æ‰€æœ‰è§„åˆ™æº
          echo "â¬‡ï¸  ä¸‹è½½å¹¶åˆå¹¶è§„åˆ™æº..."
          > combined_raw.txt  # æ¸…ç©ºæ–‡ä»¶
          
          total_sources=0
          while IFS= read -r source_url; do
            if [ -n "$source_url" ]; then
              total_sources=$((total_sources + 1))
              echo "æ­£åœ¨ä¸‹è½½ ($total_sources): $source_url"
              # ä¸‹è½½è§„åˆ™ï¼Œç§»é™¤æ³¨é‡Šã€ç©ºè¡Œå’Œç‰¹æ®Šæ ‡è®°
              curl -s "$source_url" | \
                grep -v -e "^!" -e "^#" -e "^\[" -e "^$" -e "^@@" -e "^~" >> combined_raw.txt
              
              # æ·»åŠ å»¶è¿Ÿé¿å…è¯·æ±‚è¿‡å¿«
              sleep 1
            fi
          done < sources.txt
          
          echo "âœ… å·²ä¸‹è½½ $total_sources ä¸ªè§„åˆ™æº"
          
          # å»é‡å¹¶æ’åº
          echo "ğŸ§¹ å»é‡å’Œæ’åº..."
          sort -u combined_raw.txt > combined_raw_sorted.txt
          mv combined_raw_sorted.txt combined_raw.txt
          
          initial_count=$(wc -l < combined_raw.txt | xargs)
          echo "åˆå¹¶ååŸå§‹è§„åˆ™æ•°: $initial_count"
          
          # ä¸‹è½½å¹¶åº”ç”¨è¿œç¨‹ç™½åå• (filter_45.txt)
          echo "ğŸ›¡ï¸  ä¸‹è½½å¹¶åº”ç”¨è¿œç¨‹ç™½åå• (filter_45.txt)..."
          curl -s "https://adguardteam.github.io/HostlistsRegistry/assets/filter_45.txt" | \
            grep -v -e "^!" -e "^#" -e "^\[" -e "^$" | \
            sed 's/^@@//' | sed 's/^~//' > remote_whitelist_raw.txt
          
          if [ -s "remote_whitelist_raw.txt" ]; then
            remote_whitelist_count=$(wc -l < remote_whitelist_raw.txt | xargs)
            echo "è¿œç¨‹ç™½åå•æœ‰æ•ˆæ¡ç›®: $remote_whitelist_count"
            
            # åº”ç”¨è¿œç¨‹ç™½åå•ï¼Œç§»é™¤è¢«å…è®¸çš„åŸŸå
            grep -vFx -f remote_whitelist_raw.txt combined_raw.txt > combined_whitelisted.txt
            
            remote_removed_count=$((initial_count - $(wc -l < combined_whitelisted.txt | xargs)))
            echo "é€šè¿‡è¿œç¨‹ç™½åå•ç§»é™¤æ¡ç›®: $remote_removed_count"
            
            mv combined_whitelisted.txt combined_cleaned1.txt
          else
            mv combined_raw.txt combined_cleaned1.txt
            echo "âš ï¸  è¿œç¨‹ç™½åå•ä¸‹è½½å¤±è´¥æˆ–ä¸ºç©ºï¼Œè·³è¿‡å¤„ç†"
          fi
          
          # å¤„ç†æœ¬åœ°åº”æ€¥ç™½åå• (å¦‚æœå­˜åœ¨)
          local_removed_count=0
          if [ -f "allowlist.txt" ] && [ -s "allowlist.txt" ]; then
            echo "ğŸ›¡ï¸  åº”ç”¨æœ¬åœ°åº”æ€¥ç™½åå• (allowlist.txt)..."
            # æ¸…ç†ç™½åå•æ–‡ä»¶ï¼šç§»é™¤æ³¨é‡Šã€ç©ºæ ¼å’Œç©ºè¡Œ
            sed 's/#.*//' allowlist.txt | \
                sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | \
                sed '/^$/d' > local_whitelist_clean.txt
            
            if [ -s "local_whitelist_clean.txt" ]; then
              local_whitelist_count=$(wc -l < local_whitelist_clean.txt | xargs)
              echo "æœ¬åœ°ç™½åå•æœ‰æ•ˆæ¡ç›®: $local_whitelist_count"
              
              # åº”ç”¨æœ¬åœ°ç™½åå•ï¼Œç§»é™¤è¢«å…è®¸çš„åŸŸå
              grep -vFx -f local_whitelist_clean.txt combined_cleaned1.txt > combined_cleaned.txt
              
              local_removed_count=$(( $(wc -l < combined_cleaned1.txt | xargs) - $(wc -l < combined_cleaned.txt | xargs) ))
              echo "é€šè¿‡æœ¬åœ°ç™½åå•ç§»é™¤æ¡ç›®: $local_removed_count"
            else
              mv combined_cleaned1.txt combined_cleaned.txt
              echo "â„¹ï¸  æœ¬åœ°ç™½åå•æ— æœ‰æ•ˆæ¡ç›®ï¼Œè·³è¿‡å¤„ç†"
            fi
            rm -f local_whitelist_clean.txt
          else
            mv combined_cleaned1.txt combined_cleaned.txt
            echo "â„¹ï¸  æœªæ‰¾åˆ°æœ¬åœ°ç™½åå•æ–‡ä»¶ï¼Œè·³è¿‡å¤„ç†"
          fi
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -f combined_raw.txt remote_whitelist_raw.txt combined_cleaned1.txt

          # æœ€ç»ˆå»é‡
          echo "ğŸ” æœ€ç»ˆå»é‡å¤„ç†..."
          sort -u combined_cleaned.txt > combined_final.txt
          mv combined_final.txt combined_cleaned.txt
          
          # æ£€æŸ¥è§„åˆ™è´¨é‡
          echo "ğŸ“Š è§„åˆ™è´¨é‡æ£€æŸ¥..."
          final_count=$(wc -l < combined_cleaned.txt | xargs)
          
          # ç»Ÿè®¡å„ç±»è§„åˆ™
          domain_rules=$(grep -c "^||" combined_cleaned.txt || echo "0")
          ip_rules=$(grep -c "^|" combined_cleaned.txt | grep -v "^||" || echo "0")
          element_rules=$(grep -c "^##" combined_cleaned.txt || echo "0")
          
          echo "ğŸ“ˆ æœ€ç»ˆç»Ÿè®¡:"
          echo "   åŸŸåè§„åˆ™ (||): $domain_rules"
          echo "   IPè§„åˆ™ (|): $ip_rules"
          echo "   å…ƒç´ è§„åˆ™ (##): $element_rules"
          echo "   æ€»è®¡: $final_count"
          
          # ä»…åœ¨è§„åˆ™æ•°é‡å˜åŒ–æ—¶æ›´æ–°ç‰ˆæœ¬
          previous_count=$(grep -oP '! Total count: \K\d+' list/Prime_Blocklist.txt 2>/dev/null || echo "0")
          
          if [[ "$final_count" != "$previous_count" ]] || [[ ! -f "list/Prime_Blocklist.txt" ]]; then
            new_version=$(awk "BEGIN {printf \"%.2f\", $current_version + 0.01}")
            echo $new_version > version.txt
            echo "ğŸ“ˆ è§„åˆ™æ•°å˜åŒ– ($previous_count -> $final_count)ï¼Œç‰ˆæœ¬æ›´æ–°ä¸º: $new_version"
            should_commit=true
          else
            echo "ğŸ“Š è§„åˆ™æ•°æœªå˜åŒ– ($final_count)ï¼Œä¿æŒç‰ˆæœ¬: $current_version"
            should_commit=false
          fi

          # ç”Ÿæˆæœ€ç»ˆæ–‡ä»¶å¤´
          echo "[Adblock Plus 2.0]" > header.txt
          echo "! Title: Prime Blocklist (Optimized)" >> header.txt
          echo "! Homepage: https://github.com/${{ github.repository }}" >> header.txt
          echo "! Version: $(cat version.txt)" >> header.txt
          echo "! Last modified: $(date -u +"%Y-%m-%d %H:%M:%S") UTC" >> header.txt
          echo "! Description: Optimized from multiple sources with whitelist applied." >> header.txt
          echo "! Sources:" >> header.txt
          while IFS= read -r source_url; do
            if [ -n "$source_url" ]; then
              echo "!   - $source_url" >> header.txt
            fi
          done < sources.txt
          echo "! Whitelist: https://adguardteam.github.io/HostlistsRegistry/assets/filter_45.txt" >> header.txt
          echo "! Total count: $final_count" >> header.txt
          echo "! Domain rules: $domain_rules" >> header.txt
          echo "! IP rules: $ip_rules" >> header.txt
          echo "! Element rules: $element_rules" >> header.txt
          if [ $remote_removed_count -gt 0 ]; then
            echo "! Remote whitelist entries applied: $remote_removed_count" >> header.txt
          fi
          if [ $local_removed_count -gt 0 ]; then
            echo "! Local whitelist entries applied: $local_removed_count" >> header.txt
          fi
          echo "" >> header.txt
          
          # åˆå¹¶å¤´å’Œè§„åˆ™
          cat header.txt combined_cleaned.txt > list/Prime_Blocklist.txt
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -f combined_cleaned.txt header.txt
          
          echo "âœ… ç¼–è¯‘å®Œæˆï¼"
          echo "ğŸ“ è¾“å‡ºæ–‡ä»¶: list/Prime_Blocklist.txt"
          echo "ğŸ“ æœ€ç»ˆè§„åˆ™æ•°: $final_count"
          
          if [ "$should_commit" = false ]; then
            echo "ğŸ’¤ æ— å®è´¨å˜æ›´ï¼Œå°†è·³è¿‡æäº¤ï¼ˆä»…è¿è¡Œç©ºæäº¤ä»¥ä¿æŒæ´»è·ƒï¼‰"
          fi

      - name: Commit and Push
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'
          git add list/Prime_Blocklist.txt version.txt
          
          # ä»…åœ¨è§„åˆ™æœ‰å˜åŒ–æ—¶ç”Ÿæˆæœ‰æ„ä¹‰çš„æäº¤ä¿¡æ¯
          if [[ -n $(git status --porcelain list/Prime_Blocklist.txt) ]]; then
            git commit -m "Update Prime Blocklist to v$(cat version.txt) [$(date +%Y-%m-%d)]" || echo "æ— å˜æ›´å¯æäº¤"
            git push
            echo "ğŸ”„ å·²æäº¤å¹¶æ¨é€æ–°ç‰ˆæœ¬è§„åˆ™"
          else
            git commit --allow-empty -m "Scheduled run, no changes [$(date +%Y-%m-%d)]"
            git push
            echo "â­ï¸  è§„åˆ™æ— å˜åŒ–ï¼Œå·²æ¨é€ç©ºæäº¤ä¿æŒä»“åº“æ´»è·ƒ"
          fi
